app-id: com.zquestclassic.ZQuest
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
finish-args:
  - --device=all
  - --share=network
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
command: zlauncher
rename-icon: zc
build-options:
  no-debuginfo: true
modules:
  - name: zquest
    buildsystem: simple
    build-commands:
      - pwd
      - ls
      # - install -Dm 755 chrome.sh /app/bin/chrome
      # - install -Dm 755 apply_extra.sh /app/bin/apply_extra
      # - install -Dm 755 stub_sandbox.sh /app/bin/stub_sandbox
      # - install -Dm 644 -t /app/etc cobalt.ini
      - install -Dm 644 -t /app/share/applications com.zquestclassic.ZQuest.desktop
      - install -Dm 644 -t /app/share/metainfo com.zquestclassic.ZQuest.metainfo.xml
      # - |
      #   for icon in 16 24 32 48 64 128 256; do
      #     install -Dm 644 com.google.Chrome-$icon.png /app/share/icons/hicolor/${icon}x${icon}/apps/com.google.Chrome.png
      #   done
      - echo hiiiii
      - pwd
      - ls
    post-install:
      - icon_in="zc.png";
        icon_out="zc.png";
        for s in {32,64,128,192,256,512}; do
        convert "${icon_in}" -resize "${s}" "${icon_out}";
        install -p -Dm644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
        done;
      - find . -name "*.so*" -exec mv {} ${FLATPAK_DEST}/bin/ \;
      - find . -perm /a+x -type f -exec mv {} ${FLATPAK_DEST}/bin/ \;
      - mkdir ${FLATPAK_DEST}/resources/
      - mv * ${FLATPAK_DEST}/resources/
      # See note in `zlauncher.sh` below.
      - ln -s ${FLATPAK_DEST}/bin/zelda ${FLATPAK_DEST}/resources/zelda
      - ln -s ${FLATPAK_DEST}/bin/zquest ${FLATPAK_DEST}/resources/zquest
      - ln -s ${FLATPAK_DEST}/bin/zscript ${FLATPAK_DEST}/resources/zscript
    sources:
      - type: archive
        url: https://github.com/ArmageddonGames/ZQuestClassic/releases/download/2.55-alpha-115/2.55-alpha-115-linux.tar.gz
        sha256: fd3782a997e6a0bde2b2d5b3ecc52c61468c3145e4e4fbc814502356c4a94cb4
        size: 31826824
        filename: zc.tar.gz
        only-arches: [x86_64]
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ArmageddonGames/ZQuestClassic/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith("linux.tar.gz")) | .browser_download_url
      - type: script
        dest-filename: zlauncher.sh
        commands:
          - pwd
          # This will work once we release a version using posix_spawnp
          # - export PATH=$PWD:$PATH
          # ...until then, do a big hack (see build-commands).
          - cd ../resources
          - zlauncher
      - type: file
        path: com.zquestclassic.ZQuest.metainfo.xml
      - type: file
        path: com.zquestclassic.ZQuest.desktop
    modules:
      - name: ImageMagick
        config-opts:
          - --disable-static
          - --disable-docs
          - --with-hdri
          - --with-pic
        sources:
          - type: archive
            url: https://github.com/ImageMagick/ImageMagick/archive/7.0.8-65.tar.gz
            sha256: 14afaf722d8964ed8de2ebd8184a229e521f1425e18e7274806f06e008bf9aa7
        cleanup:
          - '*'
